#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e
set -o pipefail

BUILD_DIR=$1
CACHE_DIR=$2

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

cd $BUILD_DIR
# cd ./TestC
echo "-----> BUILD DIR"
echo $BUILD_DIR
echo "-----> DIR CONTENTS"
ls -lR
echo "-----> FULL PATH OF CDIR"
pwd


# configure
if [ -f configure ]; then
  echo "-----> Configuring"
  ./configure 2>&1 | indent
fi

# make 2>&1 | indent

echo "setting-up Oracle"
echo "------------------"

CLIENT_BUILD_DIR=$BUILD_DIR/.oracle-build
mkdir -p $CLIENT_BUILD_DIR
cd $CLIENT_BUILD_DIR
curl -s -S -L https://github.com/PaulCampbell/docker-node-oracle/raw/master/oracle/linux/instantclient-basic-linux.x64-12.1.0.2.0.zip > instantclient-basic-linux.x64-12.1.0.2.0.zip
curl -s -S -L https://github.com/PaulCampbell/docker-node-oracle/raw/master/oracle/linux/instantclient-sdk-linux.x64-12.1.0.2.0.zip > instantclient-sdk-linux.x64-12.1.0.2.0.zip
unzip instantclient-basic-linux.x64-12.1.0.2.0.zip && rm instantclient-basic-linux.x64-12.1.0.2.0.zip
unzip instantclient-sdk-linux.x64-12.1.0.2.0.zip && rm instantclient-sdk-linux.x64-12.1.0.2.0.zip
echo "unzip finished"

cd instantclient_12_1
ln -s libclntsh.so.12.1 libclntsh.so
ln -s libocci.so.12.1 libocci.so

BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)
echo "BP_DIR: ${BP_DIR}"

ls $CLIENT_BUILD_DIR/instantclient_12_1/*.*
#ls $BUILD_DIR/.apt/lib/x86_64-linux-gnu/*.*

chmod 777 $CLIENT_BUILD_DIR/instantclient_12_1/*.*
#chmod 777 $BUILD_DIR/.apt/lib/x86_64-linux-gnu/*.*

cat <<EOT > $BP_DIR/export
export LD_LIBRARY_PATH=$CLIENT_BUILD_DIR/instantclient_12_1/:$BUILD_DIR/.apt/lib/x86_64-linux-gnu/${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}
#export OCI_LIB_DIR=$CLIENT_BUILD_DIR/instantclient
#export OCI_INC_DIR=$CLIENT_BUILD_DIR/instantclient/sdk/include
EOT

cat $BP_DIR/export

#if [ ! -d "$BUILD_DIR/.profile.d" ]; then
#  mkdir $BUILD_DIR/.profile.d
#fi

#cp $BP_DIR/profile/* $BUILD_DIR/.profile.d/

echo "-----> Oracle Client Installed"
echo "------------------"


echo "Running......."
uname -a

ls /tmp/build/Release/lib/
echo "chmod to /tmp/build/Release/lib/*.*"
chmod 777 /tmp/build/Release/lib/*.*
echo "exporting to LD_LP"
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/tmp/build/Release/lib/
echo $PATH
cd
cd ./Release
pwd
#cd ./ISwitchTCPIP
echo "exporting to Path of tcp"
ls 
echo $HOME
chmod 777 *
./ISwitchTCPIP

echo "Test completed"
